<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,熊猫小A,Galileo,blog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="智的博客 &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="智的博客 &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/galileo-1c8f2638f2.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/ExSearch-182e5a8868.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/katex.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700&display=swap">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/bb5fa62b4f89b103e03ee702ead78310.json"
        }
    </script>
    
<title>更进一步的夜间模式之细节一二 - 智的博客</title>
<meta name="author" content="熊猫小A" />
<meta name="description" content="又是一篇 VOID 主题开发笔记。这篇文章主要讲述 VOID 中的新夜间模式，及其实现过程的一些琐碎细节。" />
<meta property="og:title" content="更进一步的夜间模式之细节一二 - 智的博客" />
<meta property="og:description" content="又是一篇 VOID 主题开发笔记。这篇文章主要讲述 VOID 中的新夜间模式，及其实现过程的一些琐碎细节。" />
<meta property="og:site_name" content="智的博客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/archives/308/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2019-04-01T00:45:00-00.00" />
<meta name="twitter:title" content="更进一步的夜间模式之细节一二 - 智的博客" />
<meta name="twitter:description" content="又是一篇 VOID 主题开发笔记。这篇文章主要讲述 VOID 中的新夜间模式，及其实现过程的一些琐碎细节。" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
<link rel="dns-prefetch" href="//blog.imalan.cn" />
<!--
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/brand_font/embed.css" />
<style>.brand{font-family:FZCuJinLFW,serif;font-weight: normal!important;}</style>
-->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/apple-touch-icon.png?v=PY43YeeEKx">
<link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon-32x32.png?v=yyLyaqbyRG">
<link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon-16x16.png?v=yyLyaqbyRG">
<link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/safari-pinned-tab.svg?v=yyLyaqbyRG" color="#505050">
<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/favicon.ico?v=yyLyaqbyRG">
<meta name="application-name" content="三無計劃">
<meta name="apple-mobile-web-app-title" content="三無計劃">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#000000">
<meta name="baidu-site-verification" content="9BEwwo6Ibg" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/">智的博客</a></h1>
                        <p>只坚持一种正义。我的正义。</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/links/" target="_self">友链</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">更进一步的夜间模式之细节一二</h1>
            <span class="ga-post_meta ga-mono">
                <span>熊猫小A</span>
                <time>
                    2019-04-01
                </time>
                
                in <a no-style class="category" href="/category/偶尔Geek/">
                    偶尔Geek
                </a>
                
                
                <span class="leancloud_visitors" 
                    id="/archives/308/" 
                    data-flag-title="更进一步的夜间模式之细节一二"> · <i class="leancloud-visitors-count"></i> Views</span>
                
            </span>
            <div class="ga-content_body">
                <p>VOID 2.0 版本起支持了夜间模式，其控制逻辑基础是 Jad 的<a href="https://imjad.cn/archives/code/add-night-mode-to-blog">这篇文章</a>。最近在 Hran 那边看到了 macOS 10.14.4 及以上的 Safari 浏览器中通过<ruby>媒体查询<rp>(</rp><rt>media query</rt><rp>)</rp></ruby>获得用户操作系统颜色偏好的<a href="https://get233.com/archives/support-macOS-dark-mode-in-safari-web.html">方法</a>，并且受到 iOS Nightshift 功能的启发，我决定使这个功能更上一层楼。</p>
<h2>控制逻辑</h2>
<p>本文主要关注功能逻辑，不讨论夜间模式样式方面的内容。为了得到良好的体验，这个功能需要前后端结合实现。</p>
<p>后端添加一个颜色模式的设置，分为「日间模式」、「夜间模式」、「自动模式」，其中：</p>
<ul>
<li><p>日间模式：前后端均不做任何处理</p>
</li>
<li><p>夜间模式：后端直接输出 class 至 HTML 中，前端不处理</p>
</li>
<li><p>自动模式：</p>
<p>首先，为了防止前端闪烁，后端应该根据是否存在 cookie 来直接输出对应的 class 在 HTML 中。另外，前端的逻辑如下：</p>
<ol>
<li>若操作系统为深色，则切换至深色，并设置较长的 cookie 过期时间，否则进行下一步</li>
<li>若能够获得地理位置，则计算该地日出日落时间，并且：<ul>
<li>若处于夜晚，则切换至夜间模式并设置 cookie，至日出时 cookie 过期</li>
<li>若处于白天，切换至日间模式，清除 cookie</li>
</ul>
</li>
<li>若不能获得地理位置，则以固定的时间作为日出日落时间，切换逻辑与 2 中相同</li>
</ol>
</li>
</ul>
<p>厘清逻辑后实现并不困难。剩下的部分说说实现中较为关键的步骤。</p>
<h2>Cookie 的访问与设置</h2>
<p>Cookie 用于在前端存储一些信息，常用于鉴权、保存标志位等。只要浏览器没有禁用 Cookie，前端的 Cookie 会随网络请求发送至后端，这使我们可以利用该技术为各用户（浏览器）提供针对性的服务。</p>
<p><strong>在前端设置一个 Cookie：</strong></p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="s1">&#39;[NAME]=[VALUE];max-age=[AGE];path=[PATH]&#39;</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookieString</span><span class="p">;</span>
</pre></div>
<p>其中包括 <code>[NAME]</code>、<code>[AGE]</code>、<code>[PATH]</code> 参数，分别表示 Cookie 名，过期时间（秒），作用域。例如，设置 <code>theme_dark=1</code>，过期时间 1 小时，作用域为 <code>/</code>：</p>

<pre><code>var cookieString = 'theme_dark=1;max-age=3600;path=/';
document.cookie = cookieString;</code></pre>
<p><strong>在后端读取一个 Cookie（PHP）：</strong></p>
<div class="highlight"><pre><span></span><span class="x">$_COOKIE[&#39;theme_dark&#39;]; // = &#39;1&#39;</span>
</pre></div>
<p>其结果为一个字符串。更严谨的操作中需要先检查 <code>$_COOKIE</code> 数组中是否包含 <code>theme_dark</code> 字段。</p>
<h2>操作系统深色模式检查</h2>
<p>由于这个属性尚没有 JS API，Hran 给出了一个迂回方法。首先设定 CSS 属性：</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">dark-mode-state-indicator</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="p">:</span> <span class="mi">-999</span><span class="kt">em</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">-999</span><span class="kt">em</span><span class="p">;</span>
  <span class="k">z-index</span><span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">@</span><span class="k">media</span> <span class="o">(</span><span class="nt">prefers-color-scheme</span><span class="o">:</span> <span class="nt">dark</span><span class="o">)</span> <span class="p">{</span>
  <span class="p">.</span><span class="nc">dark-mode-state-indicator</span> <span class="p">{</span>
    <span class="k">z-index</span><span class="p">:</span> <span class="mi">11</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>前端使用 JS 检查：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">getDeviceState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">zIndex</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 现代浏览器</span>
        <span class="nx">zIndex</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ie8-</span>
        <span class="nx">zIndex</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">[</span><span class="s1">&#39;z-index&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">zIndex</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">getPrefersDarkModeState</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indicator</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">indicator</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;dark-mode-state-indicator&#39;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">indicator</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">getDeviceState</span><span class="p">(</span><span class="nx">indicator</span><span class="p">)</span> <span class="o">===</span> <span class="mi">11</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">getPrefersDarkModeState</span><span class="p">();</span> <span class="c1">// true or false</span>
</pre></div>
<h2>地理位置获取</h2>
<p>根据 MDN：</p>
<blockquote><p><code>Navigator.geolocation</code> 只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Geolocation"><code>Geolocation</code></a> 对象，通过这个对象可以访问到设备的位置信息。使网站或应用可以根据用户的位置提供个性化结果。</p>
</blockquote>
<div class="notice">需注意，此 API 仅在 HTTPS 协议下、现代浏览器中可用，并且需要用户授权。根据我的实践，该 API 在不同浏览器中的行为并不是那么一致，若是更严肃的场合，可能需要使用百度等服务的 workaround。</div><p>检查浏览器是否支持该 API：</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;geolocation&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">;</span> <span class="c1">// true or false</span>
</pre></div>
<p>获取用户的位置信息：</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">){</span>
  <span class="c1">// success</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">position</span><span class="p">);</span>
<span class="p">},</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="c1">// failed</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p><code>getCurrentPosition</code> 方法接受两个回调函数，第一个是成功时的回调，第二个是出错时的。出错时的回调中可以根据 <code>data.code</code> 获取出错原因，包括：</p>
<ol>
<li>PERMISSION_DENIED</li>
<li>POSITION_UNAVAILABLE</li>
<li>TIMEOUT</li>
<li>UNKNOWN_ERROR</li>
</ol>
<p>其中 <code>PERMISSION_DENIED</code> 表示用户手动禁止了网站访问位置，为了良好的体验，开发者应该向用户说明为什么会需要访问位置以及会如何使用位置信息，然后祈祷用户能重新赋予网站该权限。</p>
<h2>时间计算与比较</h2>
<h3>日出日落时间</h3>
<p>这个模块还是相对比较复杂的，其实我目前也并没有搞懂。但是令人开心的是已经有人为我们造好了轮子：<a href="https://github.com/Triggertrap/sun-js">Triggertrap/<strong>sun-js</strong></a>。这个库为原生的 Date 类注入了两个新的方法：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="p">);</span>
</pre></div>
<p>返回值是 Date 对象。结合 Geolocation，获取方法如下：</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<h3>比较时间</h3>
<p>sun-js 库得到的日出与日落时间根据当前时间不同不一定是当天的时间，例如晚间获取的日出时间其实是第二日的日出时间。考虑到 24 小时内日出日落时间不会有太大变化，为了方便比较，将日出日落时间均转换至同一天（当天），并且只精确至分钟。</p>
<div class="highlight"><pre><span></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">){</span>
  <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunset</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">sunrise</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>
  <span class="c1">// 全部转换至当天</span>
  <span class="nx">sunset</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">sunset</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span> <span class="mi">0</span><span class="p">));</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p>如此确定当前是否处于夜间：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="c1">// 格式化为小时</span>
<span class="kd">var</span> <span class="nx">sunset_s</span> <span class="o">=</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">sunset</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">sunrise_s</span> <span class="o">=</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">sunrise</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">current_s</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nx">current_s</span> <span class="o">&gt;</span> <span class="nx">sunset_s</span> <span class="o">||</span> <span class="nx">current_s</span> <span class="o">&lt;</span> <span class="nx">sunrise_s</span><span class="p">){</span>
  <span class="c1">// 夜间</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
  <span class="c1">// 日间</span>
<span class="p">}</span>
</pre></div>
<p>然后计算当前距离日出的时间：</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="nx">current_s</span> <span class="o">&gt;</span> <span class="nx">sunset_s</span><span class="p">)</span> <span class="c1">// 如果当前为夜晚，日出时间应该切换至第二日</span>
  <span class="nx">sunrise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600000</span><span class="o">*</span><span class="mi">24</span><span class="p">);</span>
<span class="c1">// 现在距日出还有 (s)</span>
<span class="kd">var</span> <span class="nx">toSunrise</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sunrise</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">current</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span> <span class="c1">// 秒</span>
</pre></div>
<p>这个时间就应该作为 Cookie 的过期时间，至日出时，该 Cookie 过期，网站则平滑地切换至日间模式。</p>
<h2>代码</h2>
<p>比较冗长，没必要贴在这里。我把代码摘出来建了一个 Gist，你可以点击查看：<a href="https://gist.github.com/AlanDecode/8b9333c28366b7af0bf0437e90a587f9">前往</a>。</p>
<hr>
<h2>2019-04-06 更新</h2>
<p>事实证明利用精确的位置来计算日出与日落大材小用了，并且随之而来的授权弹窗更是让浏览体验大打折扣。在<a href="https://blog.imalan.cn/archives/308/comment-page-1#comment-1993">评论区</a>的建议下，增加了利用时区来获取大概位置，并计算相应日出日落时间的方法。</p>
<p>核心的功能依赖 <a href="https://bitbucket.org/pellepim/jstimezonedetect">jsTimezoneDetect</a>，通过该库获取到时区名称后，将其转换为大致的位置（即时区名称对应城市的位置），然后再按照前文所述方法计算对应的日出与日落时间。我制作了一个时区名称到经纬度的转换表，<a href="https://gist.github.com/AlanDecode/9e05e4d1ed50160d012e6a3f7959c0c5">点击这里查看</a>。</p>
<p>如我在评论区中所述，仅使用时区来确定日出日落时间是不精确的，许多国家或地区只用一个时区（比如中国），但是从东到西时间差会很大（中国达到 4 小时之多）。不过权衡一下授权弹窗带来的差劲体验，这种误差也许可以接受吧。</p>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/主题/">#主题</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/VOID笔记/">#VOID笔记</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <a class="ga-highlight" href="/archives/317/">春天、联谊、新耳机</a>
        <p class="yue">趁着联谊记忆还在，新耳机的新鲜感尚未消退，还是赶紧把当前的心绪记录下来。</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/archives/307/">与电脑心连心？</a>
        <p class="yue">听上去像我和电脑进入了短暂的热恋。这太色情了。</p>
    </div>

</section>


    
        <script>
            var initValine = function () {
                new Valine({"enable": true, "el": "#vcomments", "appId": "6chFXPTjrjYnjFk9duROcboN-gzGzoHsz", "appKey": "c1CRooaFmpLs4xi7x3YLm3ma", "visitor": true, "recordIP": true, "placeholder": "\u6765\u7545\u6240\u6b32\u8a00\u5427~"});
            }
        </script>
        <script defer src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js' onload="initValine()"></script>
        <div id="vcomments"></div>
    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">智的博客</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2020 熊猫小A</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
<a no-style href="http://beian.miit.gov.cn" target="_blank">京ICP备18000133号-1</a> | 
<a no-style href="https://www.upyun.com" target="_blank">又拍云</a>

                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/AlanDecode" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/AlanDecode" target="_blank"><i class="gi gi-github"></i>GitHub</a></li><span class="separator">·</span><li><a class="no-style" title="Weibo" href="https://weibo.com/5245109677/" target="_blank"><i class="gi gi-weibo"></i>Weibo</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2017-06-29T12:00+08:00"
                    </script>
                    <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/galileo-dc4baa7cf4.js"></script>
                </footer>
            </div>
        </div>
    </div>

    <!--katex-->
    <script defer src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AlanDecode/site-Blog@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e4f3a7c02ac2aabc41a1cfa95f61a026";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script>
if(window.location.hash){
    var checkExist = setInterval(function() {
       if ($(window.location.hash).length) {
          $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
          clearInterval(checkExist);
       }
    }, 100);
}
</script>
<script>
if(window.navigator && navigator.serviceWorker) {
  caches.keys().then(function(cacheNames) {
    cacheNames.forEach(function(cacheName) {
      caches.delete(cacheName);
    });
  }).then(function(){
    console.log('Cache cleaned.');
  });
  navigator.serviceWorker.getRegistrations()
  .then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  }).then(function(){
    console.log('Service Worker stopped.');
  });
}
</script>

    </body>
</html>